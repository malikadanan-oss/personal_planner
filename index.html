<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perancang Aktiviti Peribadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .flatpickr-calendar.inline {
            box-shadow: none;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            width: 100%;
        }
        .flatpickr-day.selected { background: #3b82f6; border-color: #3b82f6; }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .content-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes fadeInNotify { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOutNotify { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        .notification-fade-in { animation: fadeInNotify 0.5s ease-out forwards; }
        .notification-fade-out { animation: fadeOutNotify 0.5s ease-in forwards; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-2xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Perancang Aktiviti</h1>
            <p class="text-gray-500 mt-2">Uruskan jadual harian anda dengan mudah.</p>
        </header>
        
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="tab-btn-rekod" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Rekod Aktiviti
                </button>
                <button id="tab-btn-senarai" class="tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Senarai Aktiviti
                </button>
            </nav>
        </div>

        <main>
            
            <div id="tab-content-rekod" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg content-fade-in">
                <form id="borang-aktiviti" novalidate>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Tarikh (Satu atau lebih)</label>
                            <input type="text" id="tarikh-display" placeholder="Tarikh yang dipilih akan muncul di sini..." readonly
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 mb-4 cursor-default">
                            <div id="kalendar-container" class="rounded-lg"></div>
                            <input type="hidden" id="tarikh" name="tarikh" required>
                        </div>
                        
                        <div>
                            <label for="tajuk" class="block text-sm font-medium text-gray-700 mb-2">Tajuk Program / Aktiviti</label>
                            <input type="text" id="tajuk" name="tajuk" placeholder="Cth: Mesyuarat Jawatankuasa" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label for="masa-mula" class="block text-sm font-medium text-gray-700 mb-2">Masa Mula</label>
                                <select id="masa-mula" name="masa-mula" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                            </div>
                            <div>
                                <label for="masa-tamat" class="block text-sm font-medium text-gray-700 mb-2">Masa Tamat</label>
                                <select id="masa-tamat" name="masa-tamat" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                            </div>
                            <div class="sm:col-span-2">
                                <label for="tempat" class="block text-sm font-medium text-gray-700 mb-2">Tempat</label>
                                <input type="text" id="tempat" name="tempat" placeholder="Cth: Bilik Mesyuarat Utama" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Medium Aktiviti</label>
                            <div class="flex items-center space-x-6 mt-2">
                                <label class="flex items-center">
                                    <input type="radio" name="medium-aktiviti" value="Aktiviti" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" required checked>
                                    <span class="ml-2 text-sm text-gray-700">Aktiviti</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="medium-aktiviti" value="Bimbingan" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" required>
                                    <span class="ml-2 text-sm text-gray-700">Bimbingan</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label for="nama-guru" class="block text-sm font-medium text-gray-700 mb-2">Nama Guru Dibimbing (Jika Berkaitan)</label>
                            <input type="text" id="nama-guru" name="nama-guru" placeholder="Cth: Puan Siti Nurhaliza"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div>
                            <label for="catatan" class="block text-sm font-medium text-gray-700 mb-2">Impak / Catatan (Pilihan)</label>
                            <textarea id="catatan" name="catatan" rows="3" placeholder="Tuliskan catatan atau impak aktiviti di sini..."
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>

                        <div>
                            <label for="tindak-susul" class="block text-sm font-medium text-gray-700 mb-2">Tindak Susul (Pilihan)</label>
                            <textarea id="tindak-susul" name="tindak-susul" rows="3" placeholder="Nyatakan tindakan susulan yang perlu diambil..."
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 flex items-center justify-center space-x-2 disabled:bg-gray-400">
                            <svg id="button-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span id="button-text">Hantar Rekod</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="tab-content-senarai" class="hidden bg-white p-6 sm:p-8 rounded-2xl shadow-lg content-fade-in">
                <div class="flex justify-between items-center mb-6 pb-4 border-b">
                    <button id="prev-month-btn" class="p-2 rounded-md hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <h2 id="month-display" class="text-xl font-bold text-gray-800 text-center"></h2>
                    <button id="next-month-btn" class="p-2 rounded-md hover:bg-gray-100 transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
                <div id="activity-list-container" class="space-y-4">
                    <div id="list-loader" class="text-center py-10 hidden">
                        <svg class="animate-spin mx-auto h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="mt-2 text-sm text-gray-500">Memuatkan rekod...</p>
                    </div>
                     <div id="no-records-msg" class="text-center py-10 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 text-gray-400"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">Tiada Aktiviti</h3>
                        <p class="mt-1 text-sm text-gray-500">Tiada rekod dijumpai untuk bulan ini.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="notification-center" class="fixed top-5 right-5 space-y-3 z-50 w-full max-w-sm"></div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // KONFIGURASI
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWxx7gAPqpOnb2kNY1qDFLTFOIglZ_UmyoymVKHMac_pzIn5RP2dWGMC9E3siw88N1/exec';

            // PEMBOLEH UBAH GLOBAL
            const tabBtnRekod = document.getElementById('tab-btn-rekod');
            const tabBtnSenarai = document.getElementById('tab-btn-senarai');
            const tabContentRekod = document.getElementById('tab-content-rekod');
            const tabContentSenarai = document.getElementById('tab-content-senarai');
            const form = document.getElementById('borang-aktiviti');
            const submitButton = document.getElementById('submit-button');
            const buttonSpinner = document.getElementById('button-spinner');
            const buttonText = document.getElementById('button-text');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const monthDisplay = document.getElementById('month-display');
            const activityListContainer = document.getElementById('activity-list-container');
            const listLoader = document.getElementById('list-loader');
            const noRecordsMsg = document.getElementById('no-records-msg');

            let currentViewDate = new Date();

            // =================================================================
            // PENGURUSAN TAB
            // =================================================================
            function switchTab(activeTab) {
                const isRekod = activeTab === 'rekod';
                tabBtnRekod.classList.toggle('active', isRekod);
                tabBtnSenarai.classList.toggle('active', !isRekod);
                tabContentRekod.classList.toggle('hidden', !isRekod);
                tabContentSenarai.classList.toggle('hidden', isRekod);
                if (!isRekod) {
                    fetchActivities();
                }
            }
            tabBtnRekod.addEventListener('click', () => switchTab('rekod'));
            tabBtnSenarai.addEventListener('click', () => switchTab('senarai'));

            // =================================================================
            // LOGIK TAB REKOD AKTIVITI (BORANG)
            // =================================================================
            const hiddenDateInput = document.getElementById('tarikh');
            const displayDateInput = document.getElementById('tarikh-display');

            const calendarInstance = flatpickr("#kalendar-container", {
                mode: "multiple", dateFormat: "Y-m-d", inline: true,
                onChange: function(selectedDates, dateStr, instance) {
                    hiddenDateInput.value = dateStr;
                    displayDateInput.value = selectedDates.map(date => instance.formatDate(date, "j F Y")).join(', ');
                    hiddenDateInput.dispatchEvent(new Event('input'));
                }
            });

            function populateTimeOptions() {
                const startTimeSelect = document.getElementById('masa-mula');
                const endTimeSelect = document.getElementById('masa-tamat');
                let optionsHTML = '';
                for (let hour = 0; hour < 24; hour++) {
                    for (let min of ['00', '30']) {
                        let h = hour;
                        let ampm = 'AM';
                        if (h >= 12) { ampm = 'PM'; if (h > 12) h -= 12; }
                        if (h === 0) h = 12;
                        const timeString = `${h}:${min} ${ampm}`;
                        optionsHTML += `<option value="${timeString}">${timeString}</option>`;
                    }
                }
                startTimeSelect.innerHTML = optionsHTML;
                endTimeSelect.innerHTML = optionsHTML;
                startTimeSelect.value = '9:00 AM';
                endTimeSelect.value = '5:00 PM';
            }
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!form.checkValidity()) {
                    showNotification('Borang Tidak Lengkap', 'Sila isi semua medan yang diperlukan.', 'error');
                    form.reportValidity(); return;
                }
                submitButton.disabled = true;
                buttonSpinner.classList.remove('hidden');
                buttonText.textContent = 'Menghantar...';
                
                const formData = new FormData(form);
                const rawData = Object.fromEntries(formData.entries());

                // *** BLOK JAVASCRIPT YANG DIKEMAS KINI (finalData) ***
                const finalData = {
                    tarikh: rawData.tarikh,
                    tajuk: rawData.tajuk,
                    tempat: rawData.tempat,
                    masa: `${rawData['masa-mula']} - ${rawData['masa-tamat']}`,
                    'medium-aktiviti': rawData['medium-aktiviti'],
                    'nama-guru': rawData['nama-guru'] || '', // Hantar string kosong jika tidak diisi
                    catatan: rawData.catatan || '', // Hantar string kosong jika tidak diisi
                    'tindak-susul': rawData['tindak-susul'] || '' // Hantar string kosong jika tidak diisi
                };
                
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST', mode: 'cors', cache: 'no-cache',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(finalData)
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showNotification('Berjaya!', 'Rekod aktiviti anda telah disimpan.');
                        form.reset(); 
                        calendarInstance.clear(); 
                        displayDateInput.value = '';
                        populateTimeOptions();
                    } else { throw new Error(result.message || 'Ralat tidak diketahui.'); }
                } catch (error) {
                    showNotification('Ralat Rangkaian', `Tidak dapat menghantar data. Butiran: ${error.message}`, 'error');
                } finally {
                    submitButton.disabled = false;
                    buttonSpinner.classList.add('hidden');
                    buttonText.textContent = 'Hantar Rekod';
                }
            });

            // =================================================================
            // LOGIK TAB SENARAI AKTIVITI
            // =================================================================
            function updateMonthDisplay() {
                monthDisplay.textContent = currentViewDate.toLocaleDateString('ms-MY', {
                    month: 'long', year: 'numeric'
                });
            }

            async function fetchActivities() {
                updateMonthDisplay();
                listLoader.classList.remove('hidden');
                activityListContainer.innerHTML = ''; // Kosongkan senarai lama
                noRecordsMsg.classList.add('hidden');
                
                const year = currentViewDate.getFullYear();
                const month = currentViewDate.getMonth() + 1; // 1-12
                const fetchUrl = `${SCRIPT_URL}?action=getRecords&year=${year}&month=${month}`;
                
                try {
                    const response = await fetch(fetchUrl);
                    const result = await response.json();
                    if (result.status === 'success') {
                        renderActivities(result.records);
                    } else {
                        throw new Error(result.message || 'Gagal memuatkan data.');
                    }
                } catch (error) {
                    showNotification('Ralat Memuatkan Data', `Butiran: ${error.message}`, 'error');
                } finally {
                    listLoader.classList.add('hidden');
                }
            }
            
            function renderActivities(records) {
                if (records.length === 0) {
                    noRecordsMsg.classList.remove('hidden');
                    activityListContainer.appendChild(noRecordsMsg);
                    return;
                }
                
                const groupedByDate = records.reduce((acc, record) => {
                    const date = new Date(record[1]).toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    if (!acc[date]) {
                        acc[date] = [];
                    }
                    acc[date].push(record);
                    return acc;
                }, {});

                for (const date in groupedByDate) {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'text-sm font-semibold text-gray-600 pb-2 mb-2 border-b';
                    dateHeader.textContent = date;
                    activityListContainer.appendChild(dateHeader);
                    
                    groupedByDate[date].forEach(record => {
                        const div = document.createElement('div');
                        div.className = 'p-4 bg-gray-50 rounded-lg flex items-start space-x-4';
                        
                        // *** BLOK PAPARAN SENARAI YANG DIKEMAS KINI ***
                        const mediumBgColor = record[5] === 'Bimbingan' ? 'bg-green-100 text-green-800' : 'bg-purple-100 text-purple-800';
                        const guruHtml = record[6] ? `<p class="mt-2 text-xs text-gray-600 border-t pt-2"><span class="font-semibold">Guru Dibimbing:</span> ${record[6]}</p>` : '';
                        const catatanHtml = record[7] ? `<p class="mt-2 text-xs text-gray-600 ${record[6] ? '' : 'border-t pt-2'}"><span class="font-semibold">Catatan:</span> ${record[7]}</p>` : '';
                        const susulHtml = record[8] ? `<p class="mt-2 text-xs text-gray-600 ${record[6] || record[7] ? '' : 'border-t pt-2'}"><span class="font-semibold">Tindak Susul:</span> ${record[8]}</p>` : '';

                        div.innerHTML = `
                            <div class="bg-blue-100 text-blue-700 p-2 rounded-full mt-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <p class="font-bold text-gray-800 pr-2">${record[2]}</p>
                                    <span class="text-xs font-semibold ${mediumBgColor} px-2 py-1 rounded-full whitespace-nowrap">${record[5]}</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">${record[3]}</p>
                                <p class="text-sm text-gray-500">${record[4]}</p>
                                ${guruHtml}
                                ${catatanHtml}
                                ${susulHtml}
                            </div>
                        `;
                        activityListContainer.appendChild(div);
                    });
                }
            }

            prevMonthBtn.addEventListener('click', () => {
                currentViewDate.setMonth(currentViewDate.getMonth() - 1);
                fetchActivities();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentViewDate.setMonth(currentViewDate.getMonth() + 1);
                fetchActivities();
            });

            // =================================================================
            // FUNGSI UMUM (NOTIFIKASI)
            // =================================================================
            function showNotification(title, message, type = 'success') {
                const notificationCenter = document.getElementById('notification-center');
                const icon = type === 'success' ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-green-500"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-red-500"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`;
                const notification = document.createElement('div');
                notification.className = 'bg-white shadow-lg rounded-lg p-4 flex items-start space-x-4 notification-fade-in';
                notification.innerHTML = `<div>${icon}</div><div class="flex-1"><p class="font-bold text-gray-800">${title}</p><p class="text-sm text-gray-600">${message}</p></div>`;
                notificationCenter.appendChild(notification);
                setTimeout(() => {
                    notification.classList.remove('notification-fade-in');
                    notification.classList.add('notification-fade-out');
                    notification.addEventListener('animationend', () => notification.remove());
                }, 5000);
            }

            // Inisialisasi awal
            populateTimeOptions();
        });
    </script>
</body>
</html>